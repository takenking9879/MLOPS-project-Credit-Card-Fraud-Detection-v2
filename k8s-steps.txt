# Crear namespace
kubectl create namespace mlops-fraud

#### instalar airflow
#Crear configuracion
kubectl create secret generic env-secret --from-env-file=src/.env -n mlops-fraud

#Tener volumenes para guardar modelos
kubectl apply -f k8s/airflow/models-pvc.yaml -n mlops-fraud

#instalar airflow
helm install my-airflow apache-airflow/airflow --namespace mlops-fraud -f k8s/airflow/airflow_values.yaml

#Borrar archivos residuales que no borra el uninstall
helm uninstall my-airflow -n mlops-fraud
kubectl delete secret my-airflow-broker-url my-airflow-fernet-key my-airflow-redis-password -n mlops-fraud

##### mlflow
# Instalar postgreSQL
helm install postgres bitnami/postgresql -n mlops-fraud -f k8s/postgres/postgres_values.yaml

# Instalar mlflow
helm install my-mlflow community-charts/mlflow -f k8s/mlflow/mlflow_values.yaml -n mlops-fraud

kubectl delete secret my-mlflow-flask-server-secret-key -n mlops-fraud

##### Controller
# Instalar el controller ingress
helm upgrade --install ingress-nginx ingress-nginx --repo https://kubernetes.github.io/ingress-nginx --namespace ingress-nginx --create-namespace
helm install ingress-rule ./k8s/ingress-rules -n mlops-fraud

# Instalar minio
helm install my-minio oci://registry-1.docker.io/cloudpirates/minio --version 0.5.6 -f k8s/minio/minio_values.yaml -n mlops-fraud

# Copiar dags dentro de contenedor (solo si usas PV y PVC, sino usa GitSync)
kubectl cp k8s/airflow/dags/. mlops-fraud/my-airflow-worker-0:/opt/airflow/dags
kubectl cp k8s/airflow/dags/. mlops-fraud/my-airflow-api-server-5bc4c89cd-2kgk9:/opt/airflow/dags
kubectl cp k8s/airflow/dags/. mlops-fraud/my-airflow-scheduler-787fdd4dd6-jb796:/opt/airflow/dags

#### Inferencia
#Tener volumenes para guardar modelos
kubectl apply -f k8s/inference/spark-checkpoints-pvc.yaml -n mlops-fraud

#Adjuntar los archivos al este (esto no se usa en gitsync)
kubectl create configmap inference-app-files \
  --from-file=k8s/airflow/dags/config_k8s.yaml \
  --from-file=k8s/inference/main.py \
  -n mlops-fraud

#inference
kubectl apply -f k8s/inference/inference_values_gitsync.yaml -n mlops-fraud


#En kafka
- Environment: FraudDetection
- Cluster: fraud_detection_cluster
- topic: transactions
- output_topic: fraud_predictions

# Generar y Correr el producer
#Generar imagen
docker build -t k8s-producer src/./producer
#Correr imagen
docker run -d \
  --name producer \
  --env-file src/.env \
  --cpus="1" \
  --memory="1g" \
  k8s-producer 