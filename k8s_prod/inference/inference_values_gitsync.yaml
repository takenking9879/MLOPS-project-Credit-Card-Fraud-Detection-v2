apiVersion: v1
kind: Pod
metadata:
  name: inference-pod
  namespace: mlops-fraud
  labels:
    app: inference-debug
spec:
  restartPolicy: Always

  securityContext:
    fsGroup: 1000   # MUY IMPORTANTE para Spark

  volumes:
    - name: models-vol
      persistentVolumeClaim:
        claimName: models-pvc

    - name: spark-checkpoints
      persistentVolumeClaim:
        claimName: spark-checkpoints-pvc

    - name: app-files
      emptyDir: {}   # ðŸ‘ˆ git-sync escribe aquÃ­

  initContainers:
    - name: wait-for-model
      image: busybox:1.36
      command: ["sh", "-c"]
      args:
        - |
          set -eu
          MODEL_PATH="/models/fraud_detection_model.pkl"
          echo "Waiting for model at $MODEL_PATH"
          i=0
          while [ ! -f "$MODEL_PATH" ]; do
            i=$((i+1))
            if [ "$i" -ge 180 ]; then
              echo "Timed out waiting for model after 30 minutes" >&2
              exit 1
            fi
            sleep 10
          done
          echo "Model found. Continuing."
      volumeMounts:
        - name: models-vol
          mountPath: /models
          readOnly: true

  containers:
    # ======================
    # INFERENCE CONTAINER
    # ======================
    - name: inference
      image: takenking9879/inference-server:latest
      imagePullPolicy: IfNotPresent

      command: ["spark-submit"]
      args:
        - "--conf"
        - "spark.driver.defaultJavaOptions=-Dlog4j2.configuration=file:/spark/conf/log4j2.properties"
        - "--conf"
        - "spark.sql.shuffle.partitions=2"
        - "/app/repo/k8s_prod/inference/main.py"

      env:
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: env-secret
              key: AWS_ACCESS_KEY_ID
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: env-secret
              key: AWS_SECRET_ACCESS_KEY
        - name: KAFKA_BOOTSTRAP_SERVERS
          valueFrom:
            secretKeyRef:
              name: env-secret
              key: KAFKA_BOOTSTRAP_SERVERS
        - name: KAFKA_USERNAME
          valueFrom:
            secretKeyRef:
              name: env-secret
              key: KAFKA_USERNAME
        - name: KAFKA_PASSWORD
          valueFrom:
            secretKeyRef:
              name: env-secret
              key: KAFKA_PASSWORD
        - name: KAFKA_TOPIC
          valueFrom:
            secretKeyRef:
              name: env-secret
              key: KAFKA_TOPIC

      resources:
        requests:
          cpu: "2"
          memory: 2Gi
        limits:
          cpu: "3"
          memory: 3Gi

      volumeMounts:
        - name: models-vol
          mountPath: /models
          readOnly: true

        - name: app-files
          mountPath: /app   # ðŸ‘ˆ cÃ³digo viene de git
          readOnly: false

        - name: spark-checkpoints
          mountPath: /mnt/checkpoints

    # ======================
    # GIT-SYNC SIDECAR
    # ======================
    - name: git-sync
      image: registry.k8s.io/git-sync/git-sync:v4.1.0

      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 200m
          memory: 256Mi

      env:
        - name: GITSYNC_REPO
          value: "https://github.com/takenking9879/MLOPS-project-Credit-Card-Fraud-Detection-v2"

        - name: GIT_SYNC_BRANCH
          value: "main"

        - name: GIT_SYNC_ROOT
          value: "/git"

        - name: GIT_SYNC_DEST
          value: "repo"

        - name: GIT_SYNC_WAIT
          value: "30"   # sync cada 30s

        - name: GITSYNC_ONE_TIME
          value: "false"

      volumeMounts:
        - name: app-files
          mountPath: /git
